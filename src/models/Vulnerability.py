import uuid
import datetime
from src.common.Database import Database
#from src.models.Project import Project

__author__ = 'RivaSecurity'


class Vulnerability(object):
    def __init__(self, report_id, name, status, severity, exploitability, owaspTop10, description, risk, remidiation,
                 references,_id=None):
        self.report_id = report_id
        self.name = name
        self.status = status
        self.severity = severity
        self.exploitability = exploitability
        self.owaspTop10 = owaspTop10
        self.description = description
        self.risk = risk
        self.remidiation = remidiation
        self.references = references
        self._id = uuid.uuid4().hex if _id is None else _id


#find one vulnerability
    @classmethod
    def getVulnerability(cls, id):
        vuln = Database.find_one(collection="vulnerabilities",  query={'_id': id})
        if vuln != None:
            return vuln
        else:
            return False

#find all vulnerabilities of on project given project id
    @classmethod
    def getVulnerabilities(cls, report_id):
        vulns = Database.find(collection="vulnerabilities", query={'report_id': report_id})
        if vulns != None:
            return vulns
        else:
            return False
#add vulnerability
    def addVulnerability(self):
        Database.insert(collection='vulnerabilities',
                        data=self.json())
#update Vulnerability
    @classmethod
    def editVulnerability(cls, id, newObj):
        vulnerability = Database.find_one(collection='vulnerabilities', query={'_id': id})
        print(vulnerability)
        if vulnerability != None:  # edit if element exists
            vulnerability = Database.update_one(collection='vulnerabilities', obj=vulnerability, newObj={"$set": newObj})
            return True
        else:
            return False
#delete on vulnerability
    @classmethod
    def deleteVulnerability(cls, id):
        vuln = Database.find_one(collection='vulnerabilities', query={'_id': id})
        if vuln != None:  # edit if element exists
            Database.delete_one(collection='vulnerabilities', query={"_id": id})
            return True
        else:
            return False


#delete all vulnerabilities of on project given project id
    @classmethod
    def deleteVulnerabilitiesOfProject(cls, report_id):
        vuln = Database.find(collection='vulnerabilities', query={'report_id': report_id})
        if vuln != None:  # edit if element exists
            print(Database.delete_many(collection='vulnerabilities', query={"report_id": report_id}))
            return True
        else:
            return False

    def json(self):
        return{
           "_id": self._id,
           "report_id": self.report_id,
           "name": self.name,
            "status": self.status,
            "severity": self.severity,
            "exploitability": self.exploitability,
            "owaspTop10": self.owaspTop10,
            "description": self.description,
            "risk": self.risk,
            "references": self.references,
            "remidiation": self.remidiation,
        }

